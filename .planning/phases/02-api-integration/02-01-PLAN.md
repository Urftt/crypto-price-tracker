---
phase: 02-api-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crypto_price_tracker/models.py
  - src/crypto_price_tracker/api.py
  - tests/test_api.py
  - pyproject.toml
autonomous: true
requirements:
  - API-01
  - API-02
  - API-03

must_haves:
  truths:
    - "Calling the API client returns current EUR prices for cryptocurrencies from the Bitvavo public API"
    - "The top N coins (default 20) are returned sorted by 24h EUR trading volume (volumeQuote) as the market cap proxy"
    - "No API key or authentication is required — all requests use public endpoints"
    - "Each coin result includes price, 24h change percentage, 24h EUR volume, and trading volume"
  artifacts:
    - path: "src/crypto_price_tracker/models.py"
      provides: "CoinData dataclass with all required fields"
      contains: "dataclass"
      min_lines: 15
    - path: "src/crypto_price_tracker/api.py"
      provides: "BitvavoClient class with get_top_coins method"
      exports: ["BitvavoClient"]
      min_lines: 50
    - path: "tests/test_api.py"
      provides: "Unit tests for API client with mocked HTTP responses"
      min_lines: 40
  key_links:
    - from: "src/crypto_price_tracker/api.py"
      to: "https://api.bitvavo.com/v2"
      via: "httpx GET requests to /ticker/24h and /assets"
      pattern: "api\\.bitvavo\\.com/v2"
    - from: "src/crypto_price_tracker/api.py"
      to: "src/crypto_price_tracker/models.py"
      via: "imports CoinData dataclass"
      pattern: "from.*models.*import.*CoinData"
    - from: "src/crypto_price_tracker/api.py"
      to: "sorted by volumeQuote"
      via: "sort key for top-N ranking"
      pattern: "sort|volumeQuote|volume_quote"
---

<objective>
Build the Bitvavo API client that fetches live EUR cryptocurrency prices and returns the top N coins sorted by trading volume.

Purpose: This is the data backbone of the entire CLI tool. Once this plan is complete, the application can fetch real market data from Bitvavo without authentication. Phase 3 (CLI and Display) will consume this client to render prices in the terminal.

Output: A `BitvavoClient` class that fetches from two public Bitvavo endpoints (`/ticker/24h` and `/assets`), filters to EUR pairs, computes 24h change %, sorts by 24h EUR volume, and returns the top N as `CoinData` dataclass instances. Includes unit tests with mocked HTTP.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Bitvavo public REST API details (discovered during planning):

**Base URL:** `https://api.bitvavo.com/v2`

**Endpoints used:**

1. `GET /ticker/24h` — Returns 24h stats for all markets (no auth required).
   Response (array of objects):
   ```json
   {
     "market": "BTC-EUR",
     "open": "55821",
     "high": "57460",
     "low": "53443",
     "last": "56754",
     "volume": "2186.73190058",
     "volumeQuote": "120339407.20944645",
     "bid": "56760",
     "bidSize": "0.10585071",
     "ask": "56765",
     "askSize": "0.01493671",
     "timestamp": 1772321424236,
     "startTimestamp": 1772235024236,
     "openTimestamp": 1772235040777,
     "closeTimestamp": 1772321422338
   }
   ```
   - `market`: Trading pair (e.g., "BTC-EUR")
   - `last`: Current price (string, parse to float)
   - `open`: Price 24h ago (for computing 24h change %)
   - `volume`: Trading volume in base asset
   - `volumeQuote`: Trading volume in quote currency (EUR) — USE THIS for sorting/ranking

2. `GET /assets` — Returns asset metadata (no auth required).
   Response (array of objects):
   ```json
   {
     "symbol": "BTC",
     "name": "Bitcoin",
     "decimals": 8,
     ...
   }
   ```
   - `symbol`: Ticker symbol
   - `name`: Human-readable name (e.g., "Bitcoin", "Ethereum")

**Important design note:** Bitvavo does NOT provide market cap data. The requirement "sorted by market cap" is best approximated by sorting by `volumeQuote` (24h EUR trading volume). This is the standard approach when market cap is unavailable from the data source — high-volume coins correlate strongly with high market cap coins. Document this in the code.

**All 438 EUR pairs** are returned by `/ticker/24h`. Filter by `market.endswith("-EUR")`.
</context>

<interfaces>
<!-- From Phase 1 plan — the package structure executor should know about -->
From src/crypto_price_tracker/__init__.py:
```python
__version__ = "0.1.0"
```

From src/crypto_price_tracker/cli.py:
```python
def main():  # Entry point — will consume the API client in Phase 3
```

From pyproject.toml:
```toml
[project]
name = "crypto-price-tracker"
dependencies = []  # Will need httpx added

[tool.hatch.build.targets.wheel]
packages = ["src/crypto_price_tracker"]
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create data models and API client with httpx</name>
  <files>src/crypto_price_tracker/models.py, src/crypto_price_tracker/api.py, pyproject.toml</files>
  <action>
**Step 1: Add httpx dependency to pyproject.toml**

Add `httpx` to the `dependencies` list in `pyproject.toml`:
```toml
dependencies = ["httpx>=0.27"]
```

Run `uv sync` to install it.

**Step 2: Create `src/crypto_price_tracker/models.py`**

Define a `CoinData` dataclass with these fields:
- `symbol: str` — Ticker symbol (e.g., "BTC")
- `name: str` — Human-readable name (e.g., "Bitcoin")
- `price: float` — Current price in EUR (from `last` field)
- `change_24h: float` — 24h change as a percentage (computed: `((last - open) / open) * 100`)
- `volume: float` — 24h trading volume in base asset
- `volume_eur: float` — 24h trading volume in EUR (from `volumeQuote`)

Use `@dataclass` from stdlib `dataclasses` module. Use `__slots__ = True` for efficiency.

**Step 3: Create `src/crypto_price_tracker/api.py`**

Create a `BitvavoClient` class:

```python
BASE_URL = "https://api.bitvavo.com/v2"
```

**Constructor `__init__(self, top_n: int = 20)`:**
- Store `top_n` as instance attribute
- Create an `httpx.Client` with a 10-second timeout and a `User-Agent` header set to `"crypto-price-tracker/0.1.0"`
- Implement `__enter__` and `__exit__` for context manager support (delegates to the httpx client)

**Method `_fetch_assets(self) -> dict[str, str]`:**
- GET `{BASE_URL}/assets`
- Return a dict mapping symbol to name: `{"BTC": "Bitcoin", "ETH": "Ethereum", ...}`
- Raise `httpx.HTTPStatusError` on non-2xx responses (use `response.raise_for_status()`)

**Method `_fetch_ticker_24h(self) -> list[dict]`:**
- GET `{BASE_URL}/ticker/24h`
- Return the raw JSON list
- Raise on non-2xx responses

**Method `get_top_coins(self) -> list[CoinData]`:**
- Call `_fetch_ticker_24h()` and `_fetch_assets()`
- Filter ticker data to only EUR pairs: `market.endswith("-EUR")`
- For each EUR ticker entry:
  - Extract symbol from market: `market.split("-")[0]`
  - Parse `last`, `open`, `volume`, `volumeQuote` from strings to floats
  - Skip entries where `open` is "0" or empty (avoid division by zero in change calc)
  - Compute `change_24h = ((last - open) / open) * 100`
  - Look up `name` from assets dict (use symbol as fallback if not found)
  - Create `CoinData` instance
- Sort by `volume_eur` descending (highest EUR volume first — this is the market cap proxy)
- Return the top `self.top_n` entries

Add a module-level convenience function:
```python
def get_top_coins(top_n: int = 20) -> list[CoinData]:
    """Fetch top N coins by 24h EUR trading volume from Bitvavo."""
    with BitvavoClient(top_n=top_n) as client:
        return client.get_top_coins()
```

Include a docstring on the class explaining that `volumeQuote` (24h EUR volume) is used as the ranking metric because Bitvavo's public API does not provide market cap data.

Do NOT add retry logic or caching — keep it simple for v1. Errors propagate to the caller.
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv sync 2>&1 | tail -3 && uv run python -c "from crypto_price_tracker.models import CoinData; from crypto_price_tracker.api import BitvavoClient, get_top_coins; print('imports OK')" && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>httpx is in pyproject.toml dependencies and installed. CoinData dataclass exists with all 6 fields. BitvavoClient class exists with get_top_coins method. Module-level get_top_coins convenience function exists. All imports resolve without error.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests and verify live API integration</name>
  <files>tests/test_api.py</files>
  <action>
**Step 1: Create test directory and file**

Create `tests/__init__.py` (empty) and `tests/test_api.py`.

Add `pytest` as a dev dependency in pyproject.toml under an optional dependency group:
```toml
[project.optional-dependencies]
dev = ["pytest>=8.0", "pytest-httpx>=0.35"]
```

Run `uv sync --all-extras` to install test dependencies.

**Step 2: Write unit tests in `tests/test_api.py`**

Use `pytest-httpx` to mock HTTP responses. Import `BitvavoClient` and `CoinData`.

**Test 1: `test_get_top_coins_returns_sorted_by_volume`**
- Mock `/ticker/24h` to return 3 EUR pairs with different `volumeQuote` values:
  ```python
  [
      {"market": "AAA-EUR", "last": "100", "open": "90", "volume": "1000", "volumeQuote": "50000", ...},
      {"market": "BBB-EUR", "last": "200", "open": "210", "volume": "500", "volumeQuote": "100000", ...},
      {"market": "CCC-EUR", "last": "50", "open": "50", "volume": "2000", "volumeQuote": "75000", ...},
  ]
  ```
  Fill in required fields (bid, ask, bidSize, askSize, timestamp, startTimestamp, openTimestamp, closeTimestamp) with dummy values.
- Mock `/assets` to return matching asset names
- Call `client.get_top_coins()` with `top_n=3`
- Assert results are sorted: BBB (100000), CCC (75000), AAA (50000) by volume_eur descending
- Assert `len(results) == 3`

**Test 2: `test_get_top_coins_filters_eur_only`**
- Mock `/ticker/24h` to include a non-EUR pair (e.g., "BTC-USDT") alongside EUR pairs
- Assert the non-EUR pair is NOT in results

**Test 3: `test_get_top_coins_computes_change_percentage`**
- Mock a coin with `open: "100"`, `last: "110"` (expect +10.0%)
- Mock a coin with `open: "200"`, `last: "190"` (expect -5.0%)
- Assert `change_24h` is computed correctly (within 0.01 tolerance using `pytest.approx`)

**Test 4: `test_get_top_coins_respects_top_n`**
- Mock 5 EUR pairs
- Create client with `top_n=2`
- Assert `len(results) == 2`
- Assert the 2 returned are the ones with highest volumeQuote

**Test 5: `test_get_top_coins_skips_zero_open`**
- Mock a coin with `open: "0"` — should be excluded (avoids division by zero)

**Step 3: Run tests**
```bash
uv run pytest tests/test_api.py -v
```

**Step 4: Verify live API call works (quick smoke test)**

Run a quick live check (NOT in the test suite — just a one-time verification):
```bash
uv run python -c "
from crypto_price_tracker.api import get_top_coins
coins = get_top_coins(top_n=5)
for c in coins:
    print(f'{c.symbol:>6} ({c.name}): EUR {c.price:.2f}  24h: {c.change_24h:+.2f}%  Vol: EUR {c.volume_eur:,.0f}')
print(f'\nFetched {len(coins)} coins successfully')
"
```

This should print 5 coins with real prices from Bitvavo.
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv sync --all-extras 2>&1 | tail -3 && uv run pytest tests/test_api.py -v 2>&1 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>All 5 unit tests pass with mocked HTTP. Live smoke test prints 5 real coins with EUR prices, 24h change %, and volume. CoinData instances contain correct values. Top-N filtering and volume-based sorting work correctly.</done>
</task>

</tasks>

<verification>
Run these commands sequentially to verify the plan is complete:

1. `uv sync --all-extras` — must install httpx, pytest, pytest-httpx without error
2. `uv run pytest tests/test_api.py -v` — all 5 tests pass
3. `uv run python -c "from crypto_price_tracker.api import get_top_coins; coins = get_top_coins(5); assert len(coins) == 5; assert all(c.price > 0 for c in coins); assert all(c.volume_eur > 0 for c in coins); print('PASS')"` — live API returns 5 valid coins
4. `uv run python -c "from crypto_price_tracker.api import get_top_coins; coins = get_top_coins(5); assert coins[0].volume_eur >= coins[1].volume_eur; print('Sorted correctly')"` — coins are sorted by EUR volume descending
</verification>

<success_criteria>
1. httpx is listed as a dependency in pyproject.toml and installed via uv sync
2. CoinData dataclass has all 6 fields: symbol, name, price, change_24h, volume, volume_eur
3. BitvavoClient.get_top_coins() returns CoinData list sorted by volume_eur descending
4. Only EUR trading pairs are included (no USDT, BTC pairs)
5. 24h change percentage is correctly computed from open/last prices
6. top_n parameter limits the number of returned coins (default 20)
7. All 5 unit tests pass with mocked HTTP responses
8. Live API call returns real EUR prices without requiring authentication
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-integration/02-01-SUMMARY.md`
</output>
