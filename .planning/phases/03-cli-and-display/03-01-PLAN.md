---
phase: 03-cli-and-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crypto_price_tracker/display.py
  - tests/test_display.py
  - pyproject.toml
autonomous: true
requirements:
  - DISP-01
  - DISP-02
  - DISP-03

must_haves:
  truths:
    - "A list of CoinData objects can be rendered as a formatted terminal table showing symbol, name, price, 24h change %, and volume"
    - "Positive 24h change values are displayed in green text and negative values in red text"
    - "A single CoinData object can be rendered as a detailed single-coin view with expanded information"
    - "All EUR prices are formatted with 2 decimal places and a EUR prefix"
    - "Large numbers (volume, market cap) use thousands separators for readability"
  artifacts:
    - path: "src/crypto_price_tracker/display.py"
      provides: "Table renderer and single-coin detail formatter"
      exports: ["render_price_table", "render_coin_detail"]
      min_lines: 60
    - path: "tests/test_display.py"
      provides: "Unit tests for display formatting with color and layout assertions"
      min_lines: 50
  key_links:
    - from: "src/crypto_price_tracker/display.py"
      to: "src/crypto_price_tracker/models.py"
      via: "imports CoinData dataclass for rendering"
      pattern: "from.*models.*import.*CoinData"
    - from: "src/crypto_price_tracker/display.py"
      to: "rich"
      via: "uses rich.table.Table and rich.console.Console for formatted output"
      pattern: "from rich"
    - from: "tests/test_display.py"
      to: "src/crypto_price_tracker/display.py"
      via: "imports render functions for testing"
      pattern: "from.*display.*import"
---

<objective>
Build the terminal display module that renders cryptocurrency data as formatted, color-coded tables and single-coin detail views.

Purpose: This is the presentation layer of the CLI tool. It takes CoinData objects from the API client and renders them as human-readable, color-coded terminal output. Plan 03-02 will wire this display module to the CLI subcommands.

Output: A `display.py` module with `render_price_table()` and `render_coin_detail()` functions, plus unit tests confirming formatting and color behavior.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<interfaces>
<!-- From Phase 2 plan — the data model this display module consumes -->
From src/crypto_price_tracker/models.py:
```python
@dataclass
class CoinData:
    symbol: str        # e.g., "BTC"
    name: str          # e.g., "Bitcoin"
    price: float       # Current price in EUR
    change_24h: float  # 24h change as percentage (e.g., 5.23 or -2.1)
    volume: float      # 24h trading volume in base asset
    volume_eur: float  # 24h trading volume in EUR
```

From src/crypto_price_tracker/api.py:
```python
def get_top_coins(top_n: int = 20) -> list[CoinData]:
    """Fetch top N coins by 24h EUR trading volume from Bitvavo."""

class BitvavoClient:
    def __init__(self, top_n: int = 20): ...
    def get_top_coins(self) -> list[CoinData]: ...
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add rich dependency and create display module with table renderer and detail view</name>
  <files>pyproject.toml, src/crypto_price_tracker/display.py</files>
  <action>
**Step 1: Add rich dependency to pyproject.toml**

Add `rich` to the `dependencies` list in `pyproject.toml`:
```toml
dependencies = ["httpx>=0.27", "rich>=13.0"]
```

Run `uv sync` to install it.

**Step 2: Create `src/crypto_price_tracker/display.py`**

Import `rich.table.Table`, `rich.console.Console`, and `CoinData` from models.

**Function `render_price_table(coins: list[CoinData], console: Console | None = None) -> None`:**

Renders a table of coins to the terminal. If `console` is None, create a default `Console()`.

- Create a `Table` with title `"Crypto Prices (EUR)"` and `show_lines=False`
- Add columns:
  - `"#"` — rank number, right-justified, style `"dim"`
  - `"Symbol"` — left-justified, style `"bold"`
  - `"Name"` — left-justified
  - `"Price (EUR)"` — right-justified
  - `"24h %"` — right-justified (color applied per-cell, not per-column)
  - `"Volume (EUR)"` — right-justified
- For each coin (enumerate from 1):
  - Format price: `f"EUR {coin.price:,.2f}"` (use comma thousands separator)
  - Format 24h change: `f"{coin.change_24h:+.2f}%"` (always show sign)
  - Color the 24h change cell: use `"[green]"` markup if `change_24h >= 0`, `"[red]"` if negative. Example: `f"[green]{change_str}[/green]"` or `f"[red]{change_str}[/red]"`
  - Format volume: `f"EUR {coin.volume_eur:,.0f}"` (no decimal places, thousands separator)
  - Add row: `table.add_row(str(rank), coin.symbol, coin.name, price_str, change_colored, volume_str)`
- Print the table: `console.print(table)`

**Function `render_coin_detail(coin: CoinData, console: Console | None = None) -> None`:**

Renders a single-coin detail view. If `console` is None, create a default `Console()`.

- Print a header: `console.print(f"\n[bold]{coin.symbol}[/bold] — {coin.name}\n")`
- Create a `Table` with `show_header=False`, `box=rich.box.SIMPLE`, `padding=(0, 2)`
- Add two columns (label and value)
- Add rows:
  - `"Price"` | `f"EUR {coin.price:,.2f}"`
  - `"24h Change"` | color-coded change string (green/red as above)
  - `"Volume"` | `f"{coin.volume:,.4f}"` (base asset volume, 4 decimals)
  - `"Volume (EUR)"` | `f"EUR {coin.volume_eur:,.0f}"`
- Print the table: `console.print(table)`

**Important notes:**
- Both functions accept an optional `console` parameter for testability (tests can capture output by passing a Console with a StringIO file).
- Do NOT add any CLI logic here — this is purely the display layer.
- Import `rich.box` for the SIMPLE box style in detail view.
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv sync 2>&1 | tail -3 && uv run python -c "from crypto_price_tracker.display import render_price_table, render_coin_detail; print('imports OK')" && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>rich is in pyproject.toml dependencies and installed. display.py exports render_price_table and render_coin_detail. Both functions accept list[CoinData] or CoinData respectively and an optional Console parameter. All imports resolve without error.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for display module</name>
  <files>tests/test_display.py</files>
  <action>
Create `tests/test_display.py`. Use `rich.console.Console` with `file=io.StringIO()` and `force_terminal=True, color_system="truecolor"` to capture rendered output for assertions.

Import `CoinData` from models and `render_price_table`, `render_coin_detail` from display.

**Helper fixture `sample_coins`:**
Create a list of 3 CoinData instances:
```python
[
    CoinData(symbol="BTC", name="Bitcoin", price=56754.0, change_24h=1.67, volume=2186.73, volume_eur=120339407.0),
    CoinData(symbol="ETH", name="Ethereum", price=2345.50, change_24h=-3.21, volume=45000.0, volume_eur=95000000.0),
    CoinData(symbol="XRP", name="Ripple", price=0.52, change_24h=0.0, volume=1000000.0, volume_eur=520000.0),
]
```

**Test 1: `test_render_price_table_contains_all_coins`**
- Capture output of `render_price_table(sample_coins, console=...)`
- Assert output contains "BTC", "ETH", "XRP"
- Assert output contains "Bitcoin", "Ethereum", "Ripple"
- Assert output contains "Crypto Prices (EUR)" (table title)

**Test 2: `test_render_price_table_formats_prices_with_eur`**
- Assert output contains "EUR" and formatted numbers like "56,754.00" or "2,345.50"

**Test 3: `test_render_price_table_colors_positive_green`**
- Capture output with `force_terminal=True, color_system="truecolor"`
- Assert the output for BTC's +1.67% change contains ANSI green escape codes or rich green markup
- Use a simple check: the string "+1.67%" should appear in the output, and it should be near a green ANSI code. Alternatively, just check that the output contains "+1.67%" somewhere.

**Test 4: `test_render_price_table_colors_negative_red`**
- Assert the output for ETH's -3.21% change contains "-3.21%" in the output

**Test 5: `test_render_coin_detail_shows_all_fields`**
- Call `render_coin_detail(sample_coins[0], console=...)`
- Assert output contains "BTC", "Bitcoin", "Price", "24h Change", "Volume"
- Assert output contains "EUR 56,754.00"
- Assert output contains "+1.67%"

**Test 6: `test_render_price_table_empty_list`**
- Call `render_price_table([], console=...)` with empty list
- Assert it does not raise an error
- Assert output contains "Crypto Prices (EUR)" (table header still shown, just no rows)

**Test 7: `test_render_coin_detail_negative_change_colored_red`**
- Call `render_coin_detail(sample_coins[1], console=...)` (ETH with -3.21%)
- Assert output contains "-3.21%"

Run tests:
```bash
uv run pytest tests/test_display.py -v
```

All 7 tests must pass.
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run pytest tests/test_display.py -v 2>&1 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>All 7 unit tests pass. Tests verify: all coins appear in table, EUR formatting with thousands separators, positive changes show with + sign, negative changes show with - sign, detail view shows all fields, empty list doesn't crash, color-coded change values.</done>
</task>

</tasks>

<verification>
Run these commands sequentially to verify the plan is complete:

1. `uv sync` — must install rich without error
2. `uv run python -c "from crypto_price_tracker.display import render_price_table, render_coin_detail; print('OK')"` — imports resolve
3. `uv run pytest tests/test_display.py -v` — all 7 tests pass
4. `uv run python -c "
from crypto_price_tracker.models import CoinData
from crypto_price_tracker.display import render_price_table, render_coin_detail
coins = [CoinData('BTC', 'Bitcoin', 56754.0, 1.67, 2186.73, 120339407.0), CoinData('ETH', 'Ethereum', 2345.50, -3.21, 45000.0, 95000000.0)]
render_price_table(coins)
render_coin_detail(coins[0])
"` — visual check that table renders with colors
</verification>

<success_criteria>
1. rich is listed as a dependency in pyproject.toml and installed via uv sync
2. display.py exports render_price_table(coins, console) and render_coin_detail(coin, console)
3. Price table shows rank, symbol, name, EUR price, color-coded 24h %, and EUR volume
4. Positive 24h change is displayed in green, negative in red
5. Single-coin detail view shows all fields with labels
6. EUR prices use comma thousands separators and 2 decimal places
7. All 7 unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-and-display/03-01-SUMMARY.md`
</output>
