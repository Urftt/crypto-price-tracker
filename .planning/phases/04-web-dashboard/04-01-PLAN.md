---
phase: 04-web-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/crypto_price_tracker/web.py
  - src/crypto_price_tracker/cli.py
  - tests/test_web.py
autonomous: true
requirements: [WEB-01, WEB-04]

must_haves:
  truths:
    - "`crypto web` starts a web server on port 8000 by default"
    - "GET /api/prices returns a JSON array of top-N coins with all CoinData fields"
    - "GET /api/coin/{symbol} returns JSON for a single coin or 404 if not found"
    - "GET / serves index.html when the static directory exists, or a JSON fallback"
    - "Server port and host are configurable via --port and --host CLI flags"
  artifacts:
    - path: "src/crypto_price_tracker/web.py"
      provides: "FastAPI application with /api/prices, /api/coin/{symbol}, and / endpoints plus run_server()"
      exports: ["create_app", "app", "run_server"]
      min_lines: 40
    - path: "tests/test_web.py"
      provides: "Unit tests for all API endpoints using TestClient + mock"
      min_lines: 30
    - path: "pyproject.toml"
      provides: "fastapi and uvicorn dependencies declared"
      contains: "fastapi"
  key_links:
    - from: "src/crypto_price_tracker/web.py"
      to: "crypto_price_tracker.api.get_top_coins"
      via: "import and direct call in endpoint handlers"
      pattern: "from crypto_price_tracker\\.api import get_top_coins"
    - from: "src/crypto_price_tracker/cli.py"
      to: "crypto_price_tracker.web.run_server"
      via: "lazy import inside cmd_web()"
      pattern: "from crypto_price_tracker\\.web import run_server"
    - from: "tests/test_web.py"
      to: "crypto_price_tracker.web.create_app"
      via: "TestClient fixture"
      pattern: "TestClient\\(.*create_app"
---

<objective>
Add a FastAPI web server with JSON API endpoints for cryptocurrency price data and a `crypto web` CLI subcommand that starts the server with uvicorn.

Purpose: Provides the backend infrastructure (JSON API + static file serving) that the frontend dashboard (Plan 04-02) will consume. Also gives users a single `crypto web` command to launch the dashboard.

Output: web.py module with FastAPI app, updated cli.py with web subcommand, pyproject.toml with new dependencies, test_web.py with endpoint tests.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/crypto_price_tracker/models.py:
```python
@dataclass(slots=True)
class CoinData:
    symbol: str
    name: str
    price: float
    change_24h: float
    volume: float
    volume_eur: float
```

From src/crypto_price_tracker/api.py:
```python
def get_top_coins(top_n: int = 20) -> list[CoinData]:
    """Fetch top N coins by 24h EUR trading volume from Bitvavo."""
```

From src/crypto_price_tracker/cli.py:
```python
def main() -> None:
    """Entry point -- parse arguments and dispatch to the appropriate command."""
    # Uses argparse with subparsers for: prices, watch, info
    # Pattern: if args.command == "X": cmd_X(args)
```
</interfaces>

Existing code note: Phase 4 was previously implemented. The files web.py, cli.py (with cmd_web), pyproject.toml (with fastapi/uvicorn deps), and test_web.py already exist in the codebase. The executor should verify the existing implementation satisfies all requirements, fix any issues found, and ensure all tests pass. Do NOT delete or rewrite working code -- enhance or fix as needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI/uvicorn dependencies and create web module with JSON API endpoints</name>
  <files>pyproject.toml, src/crypto_price_tracker/web.py</files>
  <action>
1. In pyproject.toml, ensure `fastapi>=0.115` and `uvicorn[standard]>=0.34` are in the `dependencies` list. Run `uv sync --extra dev` after any changes.

2. In src/crypto_price_tracker/web.py, ensure the module contains:

   a. `create_app()` factory function returning a FastAPI instance with:
      - `GET /api/prices` endpoint: accepts `?top=N` query param (default 20, ge=1, le=100), calls `get_top_coins(top_n=top)`, returns `[dataclasses.asdict(c) for c in coins]`
      - `GET /api/coin/{symbol}` endpoint: uppercases symbol, calls `get_top_coins(top_n=100)`, finds matching coin, returns `dataclasses.asdict(match)` or raises HTTPException(404) with descriptive detail message
      - `GET /` endpoint: serves `static/index.html` via FileResponse if it exists, otherwise returns JSON fallback `{"message": "Crypto Price Tracker API", "docs": "/docs"}`
      - Static directory mount: `app.mount("/static", StaticFiles(...))` only if STATIC_DIR exists (guarded by `if STATIC_DIR.exists()`)

   b. Module-level `app = create_app()` so `uvicorn crypto_price_tracker.web:app` works directly

   c. `run_server(host="0.0.0.0", port=8000)` function that lazily imports uvicorn and calls `uvicorn.run(app, host=host, port=port)`

   d. Use `dataclasses.asdict()` for serialization -- do NOT introduce Pydantic models for CoinData (it is already a stdlib dataclass)

   e. No CORS middleware needed -- frontend is served from the same origin
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run python -c "from crypto_price_tracker.web import create_app, app, run_server; print('OK')"</automated>
  </verify>
  <done>web.py exports create_app(), app, and run_server(). FastAPI app has /api/prices, /api/coin/{symbol}, and / endpoints. Static mount is guarded. Dependencies declared in pyproject.toml.</done>
</task>

<task type="auto">
  <name>Task 2: Add crypto web CLI subcommand and write API endpoint tests</name>
  <files>src/crypto_price_tracker/cli.py, tests/test_web.py</files>
  <action>
1. In src/crypto_price_tracker/cli.py, ensure the web subcommand is wired:

   a. `cmd_web(args)` function that:
      - Lazy-imports `run_server` from `crypto_price_tracker.web` (NOT at module top -- keeps CLI startup fast for prices/watch/info)
      - Prints `f"Starting web dashboard at http://localhost:{args.port}"`
      - Calls `run_server(host=args.host, port=args.port)`

   b. Web subparser registered with:
      - `-p`/`--port` (int, default 8000)
      - `--host` (str, default "0.0.0.0")

   c. Dispatch: `elif args.command == "web": cmd_web(args)` in the main() command router

2. In tests/test_web.py, ensure comprehensive endpoint tests exist:

   a. Fixture: `client` creates `TestClient(create_app())`
   b. Fixture: `mock_coins` returns a list of 3 CoinData instances (BTC positive change, ETH negative change, XRP zero change)
   c. Tests (all using `unittest.mock.patch("crypto_price_tracker.web.get_top_coins")`):
      - `test_api_prices_returns_json_list`: GET /api/prices returns 200, JSON list with all 6 CoinData fields
      - `test_api_prices_respects_top_param`: GET /api/prices?top=2 calls get_top_coins with top_n=2
      - `test_api_coin_returns_single_coin`: GET /api/coin/BTC returns 200, correct symbol and name
      - `test_api_coin_case_insensitive`: GET /api/coin/btc (lowercase) resolves to BTC
      - `test_api_coin_not_found_returns_404`: GET /api/coin/DOESNOTEXIST returns 404
      - `test_index_returns_response`: GET / returns 200

   d. Run tests: `uv run pytest tests/test_web.py -x -v`
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run pytest tests/test_web.py -x -v</automated>
  </verify>
  <done>`crypto web` subcommand registered and dispatched. 6+ API tests pass covering /api/prices, /api/coin/{symbol}, and / endpoints with mocked data. Full test suite (`uv run pytest`) passes with no regressions.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from crypto_price_tracker.web import create_app, app, run_server; print('imports OK')"` succeeds
2. `uv run pytest tests/test_web.py -x -v` -- all API endpoint tests pass
3. `uv run pytest -x` -- full test suite passes with no regressions
4. `uv run crypto --help` shows `web` subcommand in help output
</verification>

<success_criteria>
- FastAPI app serves JSON at /api/prices and /api/coin/{symbol}
- GET / serves index.html (if exists) or JSON fallback
- `crypto web` starts uvicorn on port 8000
- All endpoint tests pass with mocked API data
- No regressions in existing CLI/display/API tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-01-SUMMARY.md`
</output>
