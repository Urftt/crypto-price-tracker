---
phase: 04-web-dashboard
plan: 02
type: execute
wave: 1
depends_on: ["04-01"]
files_modified:
  - src/crypto_price_tracker/static/index.html
  - tests/test_web.py
autonomous: true
requirements: [WEB-01, WEB-02, WEB-03, WEB-04]

must_haves:
  truths:
    - "Opening http://localhost:8000 in a browser shows a price table with rank, symbol, name, EUR price, 24h change %, and volume columns"
    - "The price table auto-refreshes every 30 seconds without user interaction"
    - "Clicking a coin row fetches /api/coin/{symbol} and displays a detail overlay with expanded information"
    - "Positive 24h changes are styled green and negative changes are styled red"
    - "The detail view can be dismissed to return to the price table"
  artifacts:
    - path: "src/crypto_price_tracker/static/index.html"
      provides: "Complete dashboard with price table, auto-refresh, coin detail modal, color coding"
      contains: "/api/coin/"
    - path: "tests/test_web.py"
      provides: "Tests verifying frontend HTML is served and contains required elements"
      contains: "test_index_serves_html"
  key_links:
    - from: "src/crypto_price_tracker/static/index.html"
      to: "/api/prices"
      via: "fetch() in load() function"
      pattern: "fetch.*api/prices"
    - from: "src/crypto_price_tracker/static/index.html"
      to: "/api/coin/{symbol}"
      via: "fetch() in row click handler"
      pattern: "fetch.*api/coin"
    - from: "src/crypto_price_tracker/web.py"
      to: "src/crypto_price_tracker/static/index.html"
      via: "FileResponse and StaticFiles mount"
      pattern: "FileResponse|StaticFiles"
---

<objective>
Build the complete HTML/CSS/JS frontend dashboard with auto-refreshing price table, clickable coin rows with detail modal, and green/red color coding for 24h changes.

Purpose: Deliver the browser-based dashboard that fulfills all WEB-* requirements. The JSON API backend already exists from Plan 04-01; this plan creates the frontend that consumes it.

Output: A fully functional single-page dashboard in `static/index.html` and tests confirming the HTML is served with the required structure.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

<interfaces>
<!-- Key API contracts the frontend must consume. From src/crypto_price_tracker/web.py -->

GET /api/prices?top=N  ->  JSON array of coin objects:
```json
[
  {
    "symbol": "BTC",
    "name": "Bitcoin",
    "price": 56754.0,
    "change_24h": 1.67,
    "volume": 2186.73,
    "volume_eur": 120339407.0
  }
]
```

GET /api/coin/{symbol}  ->  Single coin JSON object (same shape), 404 if not found

GET /  ->  Serves static/index.html via FileResponse (or JSON fallback if file missing)

Static files served at /static/* via FastAPI StaticFiles mount (if static/ dir exists)

<!-- From src/crypto_price_tracker/models.py -->
CoinData fields: symbol (str), name (str), price (float), change_24h (float), volume (float), volume_eur (float)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build complete dashboard with price table and coin detail modal</name>
  <files>src/crypto_price_tracker/static/index.html</files>
  <action>
Rewrite the existing `src/crypto_price_tracker/static/index.html` to a complete single-page dashboard. The current file has a basic price table and auto-refresh but is missing the coin detail view on click. Build the full version with these features:

**Price Table (already partially present, enhance):**
- HTML table with columns: # (rank), Symbol, Name, Price (EUR), 24h %, Volume (EUR)
- Fetches data from `/api/prices` on page load via `fetch()`
- Auto-refreshes every 30 seconds using `setInterval(load, 30000)`
- Each row is clickable (add `cursor: pointer` and `onclick` handler)
- Price formatting: >= 1 EUR use `toLocaleString('nl-NL', {minimumFractionDigits: 2, maximumFractionDigits: 2})`, < 1 EUR use `toFixed(6)`
- Volume formatting: `toLocaleString('nl-NL', {minimumFractionDigits: 0, maximumFractionDigits: 0})`
- 24h change: prepend `+` for positive, no prefix for negative. CSS class `up` (color: #3fb950) for >= 0, `down` (color: #f85149) for < 0
- Show "Updated: HH:MM:SS" timestamp below the table after each refresh

**Coin Detail Modal (NEW - this is the main addition):**
- When a table row is clicked, fetch `/api/coin/{symbol}` for that coin
- Display a modal overlay (semi-transparent dark backdrop covering the page)
- Modal content shows expanded coin information in a card-style layout:
  - Coin header: Symbol (large, bold) and Name
  - Price: formatted in EUR
  - 24h Change: with green/red color coding and +/- prefix
  - Volume: base asset volume formatted with 4 decimal places
  - Volume (EUR): formatted with EUR prefix, no decimals
- Modal has a close button (X in top-right corner) AND closes when clicking the backdrop
- While modal is open, the price table auto-refresh continues in the background
- Modal does NOT re-fetch or re-render the detail — it stays until user dismisses

**Styling (dark theme, consistent with existing):**
- Background: #0d1117, text: #c9d1d9, accents: #58a6ff
- Monospace font family throughout
- Table max-width: 800px, hover effect on rows (#161b22 background)
- Modal backdrop: rgba(0, 0, 0, 0.7), centered card with background #161b22, border-radius 8px, padding 24px, max-width 400px
- Modal close button: positioned absolute top-right, no border, color #8b949e, hover color #c9d1d9
- Responsive: modal and table work on screens as small as 360px wide

**Implementation approach:**
- Single HTML file with inline `<style>` and `<script>` tags (no external CSS/JS files needed for this scope)
- Use vanilla JavaScript — no frameworks, no build tools
- Modal HTML structure added to the body, hidden by default with `display: none`, shown by setting `display: flex` on the backdrop
- `showDetail(symbol)` async function: fetches `/api/coin/${symbol}`, populates modal fields, shows modal
- `closeModal()` function: hides the modal backdrop
- Error handling: if `/api/coin/{symbol}` returns non-200, show an error message in the modal instead of crashing
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && test -f src/crypto_price_tracker/static/index.html && grep -q '/api/prices' src/crypto_price_tracker/static/index.html && grep -q '/api/coin/' src/crypto_price_tracker/static/index.html && grep -q 'setInterval' src/crypto_price_tracker/static/index.html && grep -q 'modal' src/crypto_price_tracker/static/index.html && grep -q '#3fb950' src/crypto_price_tracker/static/index.html && grep -q '#f85149' src/crypto_price_tracker/static/index.html && echo "PASS: all required patterns found"</automated>
  </verify>
  <done>
    - index.html contains a price table fetching from /api/prices with all 6 columns
    - Auto-refresh runs every 30 seconds via setInterval
    - Clicking a row calls showDetail(symbol) which fetches /api/coin/{symbol} and displays a modal
    - Modal shows symbol, name, price, 24h change (colored), volume, volume EUR
    - Modal closes via X button or backdrop click
    - Positive changes use green (#3fb950), negative use red (#f85149)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend integration tests verifying HTML structure and detail endpoint</name>
  <files>tests/test_web.py</files>
  <action>
Add new tests to the existing `tests/test_web.py` file. Keep all 6 existing tests intact. Add these new tests after the existing ones:

1. **`test_index_serves_html_with_table`**: GET `/` returns 200 with `Content-Type: text/html`. Response body contains `<table`, `<th>#</th>`, `<th>Symbol</th>`, `<th>Name</th>`, `<th>Price (EUR)</th>`, `<th>24h %</th>`, `<th>Volume (EUR)</th>`. This verifies WEB-01 (price table structure matches CLI output columns).

2. **`test_index_has_auto_refresh`**: GET `/` response body contains `setInterval` and `30000` (the 30-second interval). This verifies WEB-02 (auto-refresh).

3. **`test_index_has_detail_modal`**: GET `/` response body contains `/api/coin/` (the detail fetch URL pattern) and `modal` (the modal element). This verifies WEB-03 (clickable detail view).

4. **`test_index_has_color_coding`**: GET `/` response body contains both `#3fb950` (green for positive) and `#f85149` (red for negative). This verifies success criteria 5 (color coding).

5. **`test_api_coin_detail_fields_complete`**: GET `/api/coin/BTC` (with mocked get_top_coins) returns JSON with all 6 CoinData fields: symbol, name, price, change_24h, volume, volume_eur. Assert each value matches the mock data. This verifies the detail API returns complete information for the modal.

Implementation notes:
- The existing `client` and `mock_coins` fixtures are already defined — reuse them
- For HTML content tests, use `response.text` to get the HTML string and assert substrings
- The `test_index_serves_html_with_table` test does NOT need mock_coins because GET `/` serves static HTML (FileResponse), not dynamic content
- Import nothing new — all needed fixtures and imports already exist in the file
- Run with: `uv run pytest tests/test_web.py -v`
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && /home/james-turing/.local/bin/uv sync --extra dev && /home/james-turing/.local/bin/uv run pytest tests/test_web.py -v</automated>
  </verify>
  <done>
    - All original 6 tests still pass
    - 5 new tests pass: test_index_serves_html_with_table, test_index_has_auto_refresh, test_index_has_detail_modal, test_index_has_color_coding, test_api_coin_detail_fields_complete
    - Total: 11 tests in test_web.py, all passing
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `uv run pytest tests/ -v` (should show 31 total: 20 existing + 6 from 04-01 + 5 new)
2. Static file exists and contains all required HTML structure: price table, auto-refresh, modal, color classes
3. The `/api/coin/{symbol}` endpoint returns all 6 fields needed by the modal
4. Green (#3fb950) and red (#f85149) color coding present in HTML for 24h change values
</verification>

<success_criteria>
- `crypto web` starts server and serves the dashboard at http://localhost:8000
- Dashboard shows price table with rank, symbol, name, EUR price, 24h %, volume columns
- Prices auto-refresh every 30 seconds (setInterval with 30000ms)
- Clicking a coin row opens a detail modal fetching from /api/coin/{symbol}
- Modal displays symbol, name, price, 24h change (colored), volume, volume EUR
- Modal dismissible via X button or backdrop click
- Positive 24h changes styled green, negative styled red
- All 31 tests pass across the full test suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-02-SUMMARY.md`
</output>
