---
phase: 04-web-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/crypto_price_tracker/static/index.html
  - src/crypto_price_tracker/static/style.css
  - src/crypto_price_tracker/static/app.js
  - tests/test_web.py
autonomous: true
requirements: [WEB-01, WEB-02, WEB-03]

must_haves:
  truths:
    - "Opening http://localhost:8000 in a browser shows a price table with rank, symbol, name, EUR price, 24h change %, and volume columns"
    - "Positive 24h changes are displayed in green and negative in red"
    - "The price table auto-refreshes every 30 seconds without manual page reload"
    - "Clicking a coin row opens a detail modal showing expanded information for that coin"
    - "The detail modal can be closed by clicking a close button or clicking outside the modal"
  artifacts:
    - path: "src/crypto_price_tracker/static/index.html"
      provides: "HTML structure with price table and coin detail modal"
      contains: "modal"
    - path: "src/crypto_price_tracker/static/style.css"
      provides: "Dark-theme styling for table, color-coded changes, modal overlay"
      contains: "modal"
    - path: "src/crypto_price_tracker/static/app.js"
      provides: "Fetch logic, auto-refresh timer, row click handler, modal population"
      contains: "fetch.*api/coin"
  key_links:
    - from: "src/crypto_price_tracker/static/app.js"
      to: "/api/prices"
      via: "fetch() call on load and setInterval"
      pattern: "fetch.*api/prices"
    - from: "src/crypto_price_tracker/static/app.js"
      to: "/api/coin/{symbol}"
      via: "fetch() call on row click"
      pattern: "fetch.*api/coin"
    - from: "src/crypto_price_tracker/static/index.html"
      to: "style.css"
      via: "link rel=stylesheet"
      pattern: "style\\.css"
    - from: "src/crypto_price_tracker/static/index.html"
      to: "app.js"
      via: "script src"
      pattern: "app\\.js"
---

<objective>
Build the HTML/CSS/JS frontend dashboard with auto-refreshing price table and coin detail modal.

Purpose: Complete the browser-based dashboard so users can view live crypto prices and click into individual coin details -- the visual counterpart to the CLI's `prices` and `info` commands.

Output: Three static files (index.html, style.css, app.js) served by the existing FastAPI static mount, plus updated integration tests confirming the static assets are served correctly.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

@src/crypto_price_tracker/web.py
@src/crypto_price_tracker/models.py
@tests/test_web.py

<interfaces>
<!-- API endpoints the frontend consumes (from web.py, built in 04-01) -->

GET /api/prices?top=N
Returns JSON array:
```json
[
  {
    "symbol": "BTC",
    "name": "Bitcoin",
    "price": 56754.0,
    "change_24h": 1.67,
    "volume": 2186.73,
    "volume_eur": 120339407.0
  },
  ...
]
```

GET /api/coin/{symbol}
Returns single coin JSON object (same shape as above), or 404 if not found.

Static files served at /static/* via FastAPI StaticFiles mount (pre-wired in web.py).
Root / serves index.html via FileResponse if src/crypto_price_tracker/static/index.html exists.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build complete frontend with price table, auto-refresh, and coin detail modal</name>
  <files>
    src/crypto_price_tracker/static/index.html
    src/crypto_price_tracker/static/style.css
    src/crypto_price_tracker/static/app.js
  </files>
  <action>
Rewrite the existing index.html and extract CSS/JS into separate files for maintainability. The existing index.html has inline styles and script -- split into three files.

**index.html:**
- Slim HTML shell linking to /static/style.css and /static/app.js
- Contains: header with title "Crypto Prices" and subtitle mentioning EUR/Bitvavo/auto-refresh
- Price table with thead columns: #, Symbol, Name, Price (EUR), 24h %, Volume (EUR)
- Empty tbody with id="tbody" populated by JS
- "Updated" timestamp div with id="updated"
- Modal overlay div (id="modal") hidden by default, containing:
  - Modal content div with close button (x), coin title area (id="modal-title"), and detail table (id="modal-body") showing: Price, 24h Change, Volume, Volume (EUR) -- matching the CLI info command output
- Note: do NOT use any framework or build tool. Plain HTML/CSS/JS only.

**style.css:**
- Dark theme: background #0d1117, text #c9d1d9 (GitHub dark aesthetic matching existing index.html)
- Monospace font-family throughout
- Table styling: full width, max-width 900px, collapse borders, hover row highlight (#161b22)
- Header cells: uppercase, small, muted color (#8b949e)
- .symbol class: #58a6ff bold
- .name class: #8b949e
- .up class: #3fb950 (green for positive change)
- .down class: #f85149 (red for negative change)
- Clickable rows: cursor pointer on tbody tr
- Modal overlay: fixed position, full viewport, semi-transparent black background (rgba(0,0,0,0.7)), flex centered
- Modal content: background #161b22, border-radius 8px, max-width 400px, padding 24px
- Modal close button: absolute top-right, no border, white text, cursor pointer
- Modal title: bold, #58a6ff, font-size 1.2em
- Modal detail table: label-value pairs, left-aligned labels (#8b949e), right-aligned values
- Responsive: on screens narrower than 600px, reduce padding and font-size slightly

**app.js:**
- `formatPrice(n)`: if n >= 1 return toLocaleString('nl-NL', 2 decimals), else toFixed(6) -- same logic as existing
- `formatVolume(n)`: toLocaleString('nl-NL', 0 decimals)
- `formatChange(n)`: returns string with + prefix for positive, 2 decimal places
- `loadPrices()`: fetch /api/prices, build table rows. Each row has data-symbol attribute set to coin.symbol. Apply .up/.down class to change cell. Update #updated with current time.
- On DOMContentLoaded: call loadPrices(), then setInterval(loadPrices, 30000) for 30s auto-refresh
- Row click handler (use event delegation on tbody): read data-symbol from clicked row, fetch /api/coin/{symbol}, populate modal fields (title: "SYMBOL -- Name", then Price, 24h Change with color, Volume, Volume EUR), show modal by removing hidden class
- Modal close: clicking the X button or clicking the overlay background (but not the modal content itself) hides the modal by adding hidden class
- Escape key also closes modal
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && test -f src/crypto_price_tracker/static/index.html && test -f src/crypto_price_tracker/static/style.css && test -f src/crypto_price_tracker/static/app.js && grep -q 'modal' src/crypto_price_tracker/static/index.html && grep -q 'api/coin' src/crypto_price_tracker/static/app.js && grep -q 'api/prices' src/crypto_price_tracker/static/app.js && grep -q 'setInterval' src/crypto_price_tracker/static/app.js && echo "PASS: all frontend files exist with required patterns"</automated>
  </verify>
  <done>
    - index.html loads and links to style.css and app.js
    - Price table renders with rank, symbol, name, price, 24h change, and volume columns
    - 24h change cells have .up (green) or .down (red) class
    - Auto-refresh runs every 30 seconds via setInterval
    - Clicking a row fetches /api/coin/{symbol} and opens a detail modal
    - Modal closes via X button, overlay click, or Escape key
    - All styling uses dark theme consistent with the existing design
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend integration tests verifying static asset serving and modal endpoint</name>
  <files>
    tests/test_web.py
  </files>
  <action>
Add 3 new test functions to the existing tests/test_web.py file (do NOT remove or modify the existing 6 tests):

1. `test_index_serves_html_with_modal()` -- GET / returns HTML content containing the string "modal" (proving the new index.html is served, not the JSON fallback). Assert status 200 and that response body contains "modal".

2. `test_static_css_served()` -- GET /static/style.css returns status 200 and content-type contains "text/css". This confirms the StaticFiles mount is working.

3. `test_static_js_served()` -- GET /static/app.js returns status 200 and content-type contains "javascript". Also assert body contains "api/prices" to confirm the JS has the fetch logic.

These tests use the existing `client` fixture (TestClient from create_app()). No mocking needed since they test static file serving, not API data.

Note: The existing `test_index_returns_response` test still passes (it only checks status 200). The new `test_index_serves_html_with_modal` adds a stronger assertion.
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && /home/james-turing/.local/bin/uv sync --extra dev && /home/james-turing/.local/bin/uv run pytest tests/test_web.py -v</automated>
  </verify>
  <done>
    - All 9 tests in test_web.py pass (6 existing + 3 new)
    - New tests confirm: index.html contains modal markup, style.css is served with correct content-type, app.js is served and contains fetch logic
    - No existing tests broken
  </done>
</task>

</tasks>

<verification>
1. All static files exist in src/crypto_price_tracker/static/ (index.html, style.css, app.js)
2. `uv run pytest tests/test_web.py -v` -- all 9 tests pass
3. `uv run pytest` -- all project tests pass (26+ total)
4. index.html contains modal element for coin detail view
5. app.js fetches from both /api/prices and /api/coin/{symbol}
6. style.css contains .up (green) and .down (red) classes for 24h change coloring
</verification>

<success_criteria>
- Browser at http://localhost:8000 shows a dark-themed price table with rank, symbol, name, EUR price, 24h change %, and volume
- Positive changes are green, negative are red
- Table auto-refreshes every 30 seconds without manual page reload
- Clicking any coin row opens a modal showing that coin's detail information fetched from /api/coin/{symbol}
- Modal closes via X button, clicking outside, or pressing Escape
- All 9 web tests pass, all project tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-02-SUMMARY.md`
</output>
