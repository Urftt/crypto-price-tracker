---
phase: 04-web-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/crypto_price_tracker/static/index.html
  - tests/test_web.py
autonomous: true
requirements: [WEB-01, WEB-02, WEB-03, WEB-04]

must_haves:
  truths:
    - "Browser shows a price table with rank, symbol, name, EUR price, 24h change %, and volume columns"
    - "Dashboard auto-refreshes prices every 30 seconds without manual page reload"
    - "Clicking a coin row opens a detail modal with expanded information for that coin"
    - "Positive 24h changes are displayed in green (#3fb950) and negative in red (#f85149)"
    - "Modal closes via X button or clicking the backdrop outside the card"
  artifacts:
    - path: "src/crypto_price_tracker/static/index.html"
      provides: "Single-page dashboard with price table, auto-refresh, coin detail modal, dark theme"
      min_lines: 100
      contains: "setInterval"
    - path: "tests/test_web.py"
      provides: "Integration tests verifying HTML structure, auto-refresh, modal, color coding, and detail fields"
      min_lines: 80
  key_links:
    - from: "src/crypto_price_tracker/static/index.html"
      to: "/api/prices"
      via: "fetch() in load() function called on page load and every 30s via setInterval"
      pattern: "fetch.*api/prices"
    - from: "src/crypto_price_tracker/static/index.html"
      to: "/api/coin/{symbol}"
      via: "fetch() in showDetail(symbol) called on table row click"
      pattern: "fetch.*api/coin/"
    - from: "tests/test_web.py"
      to: "src/crypto_price_tracker/static/index.html"
      via: "GET / serves index.html, tests assert on HTML content"
      pattern: "client\\.get\\(\"/\"\\)"
---

<objective>
Build a complete single-page HTML/CSS/JS dashboard that displays a live price table fetched from the backend API, auto-refreshes every 30 seconds, and provides a clickable coin detail modal.

Purpose: Delivers the user-facing web dashboard that fulfills all WEB requirements -- price table matching CLI output, auto-refresh, detail view on click, and color-coded 24h changes.

Output: static/index.html with the complete SPA, updated test_web.py with frontend integration tests.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

<interfaces>
<!-- Backend API contracts consumed by the frontend -->

GET /api/prices?top=N returns JSON array:
```json
[
  {
    "symbol": "BTC",
    "name": "Bitcoin",
    "price": 56754.0,
    "change_24h": 1.67,
    "volume": 2186.73,
    "volume_eur": 120339407.0
  }
]
```

GET /api/coin/{symbol} returns JSON object:
```json
{
  "symbol": "BTC",
  "name": "Bitcoin",
  "price": 56754.0,
  "change_24h": 1.67,
  "volume": 2186.73,
  "volume_eur": 120339407.0
}
```
Returns 404 with `{"detail": "Coin 'XXX' not found in top 100 EUR pairs"}` if not found.

GET / serves static/index.html via FileResponse (Plan 04-01 set this up).
</interfaces>

Existing code note: Phase 4 was previously implemented. static/index.html and the frontend tests in test_web.py already exist. The executor should verify the existing implementation satisfies all requirements, fix any issues found, and ensure all tests pass. Do NOT delete or rewrite working code -- enhance or fix as needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build complete dashboard with price table and coin detail modal</name>
  <files>src/crypto_price_tracker/static/index.html</files>
  <action>
Ensure src/crypto_price_tracker/static/index.html exists as a complete single-page dashboard. The file must contain ALL of the following in a single self-contained HTML file (inline CSS + inline JS, no external dependencies, no build tools):

**HTML structure:**
- `<h1>` with page title
- Subtitle noting "auto-refreshes every 30s"
- `<table>` with `<thead>` containing columns: #, Symbol, Name, Price (EUR), 24h %, Volume (EUR)
- `<tbody id="tbody">` populated dynamically by JavaScript
- `<div id="updated">` showing last refresh timestamp
- Modal overlay: `<div id="modal-backdrop">` containing `<div id="modal-card">` with:
  - Close button (`<button id="modal-close">` with &amp;times; character)
  - Header: `<span id="modal-symbol">` and `<span id="modal-name">`
  - Detail rows: Price (EUR), 24h Change, Volume, Volume (EUR) -- each in a `<div class="detail-row">` with label and value spans
  - Error display: `<div id="modal-error">` hidden by default

**CSS (dark theme):**
- Body: `background: #0d1117; color: #c9d1d9; font-family: monospace`
- Table: collapsed borders, hover highlight on rows, `cursor: pointer` on data rows
- `.symbol` class: `color: #58a6ff; font-weight: bold`
- `.up` class: `color: #3fb950` (green for positive 24h change)
- `.down` class: `color: #f85149` (red for negative 24h change)
- Modal backdrop: fixed fullscreen overlay with `rgba(0,0,0,0.7)` background, `display:none` by default, `display:flex` when visible (centered content)
- Modal card: `background: #161b22; border-radius: 8px; padding: 24px; max-width: 400px`

**JavaScript:**
- Helper functions:
  - `fmt(n, dec=2)` using `toLocaleString('nl-NL', ...)` for EUR number formatting
  - `fmtPrice(n)` -- if n >= 1 use fmt(n) (2 decimals), else use n.toFixed(6)
  - `fmtVol(n)` -- toLocaleString with 0 decimal places for volume

- `async function load()`:
  - Fetches `/api/prices`, parses JSON
  - Populates tbody with `<tr>` rows: rank (i+1), symbol (class="symbol"), name (class="name"), EUR price, 24h % (class="up" or "down" based on sign, prefix "+" for positive), EUR volume
  - Each row has `onclick="showDetail('${c.symbol}')"`
  - Updates the timestamp div with current time

- `async function showDetail(symbol)`:
  - Shows modal (backdrop display=flex), resets all fields to "..."
  - Fetches `/api/coin/{symbol}`
  - On success: populates modal fields (symbol, name, price, change with color class, volume, volume EUR)
  - On non-200: hides detail rows, shows error message in modal-error div
  - On catch: shows generic error in modal-error div

- `function closeModal()`: sets backdrop display=none
- `function handleBackdropClick(event)`: only closes if event.target is the backdrop itself (not the card content)

- Auto-refresh: `load()` called on page load, then `setInterval(load, 30000)` for 30-second refresh
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run python -c "
from pathlib import Path
html = Path('src/crypto_price_tracker/static/index.html').read_text()
checks = [
    ('table' in html, 'has table'),
    ('setInterval' in html, 'has setInterval'),
    ('30000' in html, 'has 30s interval'),
    ('/api/prices' in html, 'fetches prices'),
    ('/api/coin/' in html, 'fetches coin detail'),
    ('#3fb950' in html, 'has green color'),
    ('#f85149' in html, 'has red color'),
    ('modal' in html, 'has modal'),
]
for ok, label in checks:
    assert ok, f'FAIL: {label}'
print('All HTML checks passed')
"</automated>
  </verify>
  <done>index.html is a complete SPA: price table with 6 columns, auto-refresh via setInterval(load, 30000), coin detail modal with click handling, dark theme, green/red color coding for 24h changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add frontend integration tests verifying HTML structure and detail endpoint</name>
  <files>tests/test_web.py</files>
  <action>
Add integration tests to tests/test_web.py that verify the frontend HTML structure served by the backend. These tests use the existing `client` fixture (TestClient) to GET / and inspect the response body.

Ensure the following tests exist (add any that are missing):

1. `test_index_serves_html_with_table(client)`:
   - GET / returns 200 with content-type text/html
   - Body contains `<table`, `<th>#</th>`, `<th>Symbol</th>`, `<th>Name</th>`, `<th>Price (EUR)</th>`, `<th>24h %</th>`, `<th>Volume (EUR)</th>`
   - (Verifies WEB-01: price table matching CLI output columns)

2. `test_index_has_auto_refresh(client)`:
   - Body contains `setInterval` and `30000`
   - (Verifies WEB-02: auto-refresh every 30 seconds)

3. `test_index_has_detail_modal(client)`:
   - Body contains `/api/coin/` and `modal`
   - (Verifies WEB-03: detail view on click)

4. `test_index_has_color_coding(client)`:
   - Body contains `#3fb950` (green) and `#f85149` (red)
   - (Verifies color coding for positive/negative 24h changes)

5. `test_api_coin_detail_fields_complete(client, mock_coins)`:
   - GET /api/coin/BTC with mocked data returns JSON with all 6 fields matching exact mock values
   - Verifies: symbol=="BTC", name=="Bitcoin", price==56754.0, change_24h==1.67, volume==2186.73, volume_eur==120339407.0

Run full test suite to confirm no regressions: `uv run pytest -x -v`
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run pytest tests/test_web.py -x -v</automated>
  </verify>
  <done>5 frontend integration tests pass: HTML table structure (WEB-01), auto-refresh markers (WEB-02), detail modal presence (WEB-03), color coding, and complete detail API fields. Full test suite passes with no regressions.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_web.py -x -v` -- all 11 web tests pass (6 API + 5 frontend)
2. `uv run pytest -x` -- full test suite passes (31 tests: 5 API, 7 CLI, 8 display, 11 web)
3. index.html contains: `<table>`, `setInterval`, `30000`, `/api/prices`, `/api/coin/`, `#3fb950`, `#f85149`, `modal`
4. `crypto web` starts the server and / serves the dashboard in a browser
</verification>

<success_criteria>
- Price table displays rank, symbol, name, EUR price, 24h change %, volume columns
- Dashboard auto-refreshes every 30 seconds via setInterval
- Clicking a row opens a detail modal fetching /api/coin/{symbol}
- Positive changes green (#3fb950), negative changes red (#f85149)
- Modal closes on X button click or backdrop click
- All 11 web tests pass, full suite has no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-02-SUMMARY.md`
</output>
