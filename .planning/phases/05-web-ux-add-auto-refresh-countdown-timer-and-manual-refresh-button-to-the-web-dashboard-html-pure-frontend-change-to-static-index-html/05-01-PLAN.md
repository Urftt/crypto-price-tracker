---
phase: 05-web-ux-add-auto-refresh-countdown-timer-and-manual-refresh-button-to-the-web-dashboard-html-pure-frontend-change-to-static-index-html
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crypto_price_tracker/static/index.html
  - tests/test_web.py
autonomous: true
requirements: [UX-01, UX-02]

must_haves:
  truths:
    - "User sees a countdown timer showing seconds until the next auto-refresh"
    - "User sees a Refresh Now button they can click to immediately reload prices"
    - "Clicking Refresh Now fetches fresh prices and resets the countdown to the full interval"
    - "The countdown decrements visually every second from 30 down to 0"
    - "When the countdown reaches 0, prices auto-refresh and the countdown resets to 30"
  artifacts:
    - path: "src/crypto_price_tracker/static/index.html"
      provides: "Countdown timer display, manual refresh button, 1-second tick interval replacing the 30-second setInterval"
      min_lines: 120
      contains: "countdown"
    - path: "tests/test_web.py"
      provides: "Tests verifying countdown timer and refresh button exist in HTML"
      min_lines: 90
      contains: "countdown"
  key_links:
    - from: "src/crypto_price_tracker/static/index.html"
      to: "setInterval(tick, 1000)"
      via: "1-second tick function that decrements countdown and calls load() when it hits 0"
      pattern: "setInterval.*tick.*1000"
    - from: "src/crypto_price_tracker/static/index.html"
      to: "refreshNow()"
      via: "Button onclick handler that calls load() and resets countdown"
      pattern: "refreshNow"
---

<objective>
Add an auto-refresh countdown timer and a manual "Refresh Now" button to the web dashboard. The countdown shows seconds remaining until the next automatic price refresh, decrementing every second. The button lets the user trigger an immediate refresh and reset the countdown.

Purpose: Gives users visibility into when the next refresh will happen and control to refresh on demand, improving the dashboard UX without any backend changes.

Output: Updated static/index.html with countdown timer and refresh button, updated tests verifying the new UI elements.
</objective>

<execution_context>
@/home/james-turing/.claude/get-shit-done/workflows/execute-plan.md
@/home/james-turing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-dashboard/04-02-SUMMARY.md

<interfaces>
<!-- Current frontend structure in index.html (vanilla JS, no frameworks) -->

Current auto-refresh mechanism (to be replaced):
```javascript
load();
setInterval(load, 30000);
```

Current subtitle (hardcoded):
```html
<div class="subtitle">Live EUR prices via Bitvavo &middot; auto-refreshes every 30s</div>
```

Key functions already present:
```javascript
async function load()     // Fetches /api/prices, populates table, updates timestamp
function closeModal()     // Hides modal backdrop
function handleBackdropClick(event)  // Closes modal on backdrop click
```

Formatting helpers already present:
```javascript
const fmt = (n, dec=2) => n.toLocaleString('nl-NL', {...});
const fmtPrice = n => n >= 1 ? fmt(n) : n.toFixed(6);
const fmtVol = n => n.toLocaleString('nl-NL', {...});
```

CSS uses dark theme: background #0d1117, text #c9d1d9, accent #58a6ff, green #3fb950, red #f85149.
</interfaces>

Existing code note: This is a pure frontend change. Only `src/crypto_price_tracker/static/index.html` and `tests/test_web.py` are modified. No backend (web.py) changes needed. The refresh interval remains hardcoded at 30 seconds in the frontend.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add countdown timer and manual refresh button to the dashboard</name>
  <files>src/crypto_price_tracker/static/index.html</files>
  <action>
Modify `src/crypto_price_tracker/static/index.html` to add a visible countdown timer and a manual refresh button. All changes are to the existing single-file HTML/CSS/JS dashboard.

**HTML changes:**

1. Replace the static subtitle div:
   ```html
   <div class="subtitle">Live EUR prices via Bitvavo &middot; auto-refreshes every 30s</div>
   ```
   With a subtitle that includes a countdown display and refresh button:
   ```html
   <div class="subtitle">
     Live EUR prices via Bitvavo &middot;
     next refresh in <span id="countdown">30</span>s
     <button id="refresh-btn" onclick="refreshNow()" title="Refresh now">&#8635; Refresh</button>
   </div>
   ```
   The `&#8635;` is the Unicode clockwise arrow character.

**CSS changes:**

2. Add styles for the refresh button (inside the existing `<style>` block):
   ```css
   #refresh-btn {
     background: #21262d;
     color: #c9d1d9;
     border: 1px solid #30363d;
     border-radius: 4px;
     padding: 2px 10px;
     font-family: monospace;
     font-size: 0.85em;
     cursor: pointer;
     margin-left: 8px;
     vertical-align: middle;
   }
   #refresh-btn:hover {
     background: #30363d;
     border-color: #58a6ff;
     color: #58a6ff;
   }
   #countdown {
     color: #58a6ff;
     font-weight: bold;
   }
   ```

**JavaScript changes:**

3. Replace the current auto-refresh mechanism at the bottom of the script block. Remove:
   ```javascript
   load();
   setInterval(load, 30000);
   ```

   Replace with a countdown-based refresh system:
   ```javascript
   const REFRESH_SECONDS = 30;
   let secondsLeft = REFRESH_SECONDS;

   function tick() {
     secondsLeft--;
     if (secondsLeft <= 0) {
       secondsLeft = REFRESH_SECONDS;
       load();
     }
     document.getElementById('countdown').textContent = secondsLeft;
   }

   async function refreshNow() {
     secondsLeft = REFRESH_SECONDS;
     document.getElementById('countdown').textContent = secondsLeft;
     await load();
   }

   // Initial load + start 1-second countdown tick
   load();
   setInterval(tick, 1000);
   ```

   Key design decisions:
   - `REFRESH_SECONDS = 30` constant at the top of the refresh logic for clarity
   - `secondsLeft` tracks the countdown state
   - `tick()` runs every 1 second, decrements counter, triggers `load()` when it hits 0 then resets
   - `refreshNow()` resets counter and calls `load()` immediately â€” wired to button onclick
   - The countdown `<span>` updates every second so the user sees "30, 29, 28..." in real time
   - The initial load() call remains so prices appear immediately on page open

**Do NOT change:**
- The `load()` function itself (price fetching logic)
- The modal system (showDetail, closeModal, handleBackdropClick)
- The color scheme or table structure
- Any backend files
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run python -c "
from pathlib import Path
html = Path('src/crypto_price_tracker/static/index.html').read_text()
checks = [
    ('countdown' in html, 'has countdown element'),
    ('refresh-btn' in html, 'has refresh button'),
    ('refreshNow' in html, 'has refreshNow function'),
    ('REFRESH_SECONDS' in html, 'has REFRESH_SECONDS constant'),
    ('tick' in html, 'has tick function'),
    ('setInterval(tick' in html, 'has 1-second tick interval'),
    ('1000' in html, 'uses 1000ms interval'),
    ('#8635' in html or '8635' in html, 'has refresh icon character'),
    ('secondsLeft' in html, 'has secondsLeft variable'),
    ('/api/prices' in html, 'still fetches prices'),
    ('modal' in html, 'modal still present'),
    ('#3fb950' in html, 'green color still present'),
    ('#f85149' in html, 'red color still present'),
]
for ok, label in checks:
    assert ok, f'FAIL: {label}'
print('All HTML checks passed')
"</automated>
  </verify>
  <done>index.html has a visible countdown timer showing seconds until next refresh, a "Refresh" button that triggers immediate data reload, and a 1-second tick interval that decrements the counter and auto-refreshes when it hits 0. Existing table, modal, and color coding are unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for countdown timer and refresh button</name>
  <files>tests/test_web.py</files>
  <action>
Add new tests to `tests/test_web.py` that verify the countdown timer and manual refresh button are present in the served HTML. Also update the existing `test_index_has_auto_refresh` test since the auto-refresh mechanism changed from `setInterval(load, 30000)` to `setInterval(tick, 1000)`.

**Update existing test:**

1. `test_index_has_auto_refresh(client)`:
   - Change assertions to match the new countdown-based mechanism:
   - Assert body contains `setInterval` (still uses setInterval, but for 1-second tick)
   - Assert body contains `REFRESH_SECONDS` (the configurable constant)
   - Assert body contains `tick` (the per-second function)
   - Remove assertion for `30000` (no longer in HTML; replaced by 1000ms tick)

**Add new tests:**

2. `test_index_has_countdown_timer(client)`:
   - GET / returns HTML containing:
   - `id="countdown"` (the countdown display span)
   - `secondsLeft` (the JS countdown state variable)
   - `tick` (the per-second decrement function)

3. `test_index_has_refresh_button(client)`:
   - GET / returns HTML containing:
   - `id="refresh-btn"` (the button element)
   - `refreshNow` (the onclick handler function)

Run the full test suite to confirm no regressions: `uv run pytest -x -v`
  </action>
  <verify>
    <automated>cd /home/james-turing/repos/crypto-price-tracker-v2 && uv run pytest tests/test_web.py -x -v</automated>
  </verify>
  <done>Tests verify: (1) countdown timer element and tick function exist in HTML, (2) refresh button with refreshNow handler exists in HTML, (3) updated auto-refresh test confirms REFRESH_SECONDS-based mechanism. Full test suite passes with no regressions.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_web.py -x -v` -- all web tests pass (existing + 2 new)
2. `uv run pytest -x` -- full test suite passes with no regressions
3. index.html contains: countdown span, refresh button, refreshNow function, REFRESH_SECONDS constant, tick function, setInterval(tick, 1000)
4. index.html still contains: table, modal, /api/prices, /api/coin/, #3fb950, #f85149
</verification>

<success_criteria>
- Countdown timer visible in subtitle area showing seconds until next refresh
- "Refresh" button present next to countdown, styled to match dark theme
- Clicking refresh button calls load() immediately and resets countdown to 30
- Countdown decrements every second from 30 to 0
- When countdown hits 0, load() is called and countdown resets to 30
- Existing price table, modal, and color coding are unaffected
- All web tests pass including 2 new tests for countdown and refresh button
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-ux-add-auto-refresh-countdown-timer-and-manual-refresh-button-to-the-web-dashboard-html-pure-frontend-change-to-static-index-html/05-01-SUMMARY.md`
</output>
